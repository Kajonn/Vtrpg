name: CI

# Trigger on pull requests to any branch and pushes to main
on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main

# Allow concurrent runs on different commits, but cancel in-progress runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Backend testing with Go - runs unit tests with race detection and coverage
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Go using version from go.mod (1.24.3)
      # Automatically caches Go modules when cache: true is set
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
      
      # Run tests with race detection and generate coverage report
      - name: Run Go tests
        run: go test ./... -v -race -coverprofile=coverage.out -covermode=atomic
      
      # Upload coverage report as artifact for later analysis
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage-report
          path: coverage.out
          retention-days: 30
      
      # Display coverage summary in the job
      - name: Display coverage summary
        if: always()
        run: |
          echo "## Test Coverage :bar_chart:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | tail -n 1 >> $GITHUB_STEP_SUMMARY

  # Frontend linting - checks code style and potential issues
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Node.js 20 (LTS) with npm caching
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Install dependencies (uses clean install for CI)
      - name: Install npm dependencies
        run: npm ci
      
      # Run ESLint to check code quality
      - name: Run ESLint
        run: npm run lint

  # End-to-end testing with Playwright - tests full application flow
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Go for building the backend server
      # Automatically caches Go modules when cache: true is set
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
      
      # Set up Node.js for building frontend and running Playwright
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Build the Go backend server binary
      - name: Build backend server
        run: go build -o server ./cmd/server
      
      # Install npm dependencies for frontend and Playwright
      - name: Install npm dependencies
        run: npm ci
      
      # Build the production frontend bundle
      - name: Build frontend
        run: npm run build
      
      # Cache Playwright browsers to speed up subsequent runs
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      
      # Install Playwright browsers and system dependencies (uses cache when available)
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      
      # Install system dependencies even if browsers are cached
      - name: Install Playwright system dependencies
        run: npx playwright install-deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      
      # Start the Go server in the background with test configuration
      - name: Start server
        run: |
          mkdir -p /tmp/uploads
          PORT=8080 \
          FRONTEND_DIR=dist \
          UPLOAD_DIR=/tmp/uploads \
          ALLOWED_ORIGINS=http://localhost:8080 \
          ./server > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid
          echo "Server started with PID $(cat /tmp/server.pid)"
      
      # Wait for server to be ready before running tests
      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to be ready..."
          MAX_ATTEMPTS=30
          INTERVAL=2
          TOTAL_WAIT=$((MAX_ATTEMPTS * INTERVAL))
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -s http://localhost:8080 > /dev/null; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i/$MAX_ATTEMPTS: Server not ready yet, waiting..."
            sleep $INTERVAL
          done
          echo "Server failed to start within $TOTAL_WAIT seconds"
          echo "=== Server logs ==="
          cat /tmp/server.log
          exit 1
      
      # Run Playwright end-to-end tests
      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true
      
      # Upload Playwright report on failure for debugging
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      # Upload Playwright test results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 30
      
      # Clean up: stop the server
      - name: Stop server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            SERVER_PID=$(cat /tmp/server.pid)
            if kill -0 $SERVER_PID 2>/dev/null; then
              echo "Stopping server with PID $SERVER_PID"
              kill $SERVER_PID
              # Wait for graceful shutdown
              sleep 2
              # Force kill if still running
              if kill -0 $SERVER_PID 2>/dev/null; then
                kill -9 $SERVER_PID
              fi
            fi
          fi
      
      # Show server logs if tests failed for debugging
      - name: Show server logs on failure
        if: failure()
        run: |
          echo "=== Server logs ==="
          cat /tmp/server.log || echo "No server logs found"

  # Summary job - provides overall CI status (optional but useful for PR checks)
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-lint, e2e-tests]
    if: always()
    permissions: {}
    
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.backend-tests.result }}" != "success" ] || \
             [ "${{ needs.frontend-lint.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
